name: Gatekeeper DevSecOps Pipeline

on:
    push:
        branches: ['main']

jobs:
    build-and-test:
        runs-on: ubuntu-latest

        steps:
            # Step 1: Checkout Code
            - name: Checkout Code
              uses: actions/checkout@v3
              with:
                  fetch-depth: 0 # Important: Gitleaks needs the full history to find secrets

            # Step 2: Secret Scanning (The New Gatekeeper)
            - name: Run Gitleaks
              uses: gitleaks/gitleaks-action@v2
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            # Step 3: Build Docker Image (Only runs if Step 2 passes)
            - name: Build Docker Image
              run: docker build -t gatekeeper-app .

            - name: Verify Build
              run: echo "Build successful!"
